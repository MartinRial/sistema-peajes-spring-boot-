<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Peajes - Panel de Administración</title>

    <!-- Bootstrap 5.3.8 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous" />

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/style.css" />

    <!-- Vista Web Script -->
    <script src="/vistaWeb.js"></script>
    <script src="/sse.js"></script>
  </head>
  <body>
    <script src="/utilesVista.js"></script>
    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="app-wrapper">
      <!-- Sidebar Navigation -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h1 class="sidebar-brand">
            <i class="bi bi-coin"></i>
            Sistema Peajes
          </h1>
          <p class="sidebar-user text-truncate" id="nombreCompleto"></p>
        </div>

        <nav>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item">
              <a href="#" class="sidebar-nav-link active" onclick="cargarContenido('emular_transito.html'); return false;" data-page="emular_transito">
                <i class="sidebar-nav-icon bi bi-truck"></i>
                <span>Emular Tránsito</span>
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="#" class="sidebar-nav-link" onclick="cargarContenido('asignar_bonificaciones.html'); return false;" data-page="asignar_bonificaciones">
                <i class="sidebar-nav-icon bi bi-gift"></i>
                <span>Asignar Bonificaciones</span>
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="#" class="sidebar-nav-link" onclick="cargarContenido('cambiar_estado_propietario.html'); return false;" data-page="cambiar_estado_propietario">
                <i class="sidebar-nav-icon bi bi-person-gear"></i>
                <span>Estado Propietario</span>
              </a>
            </li>
          </ul>
        </nav>

        <div class="sidebar-footer">
          <button class="btn btn-logout" onclick="logout()">
            <i class="bi bi-box-arrow-right me-2"></i>
            Cerrar Sesión
          </button>
        </div>
      </aside>

      <!-- Main Content Area -->
      <main class="main-content">
        <div class="content-iframe-wrapper">
          <iframe id="contenidoFrame" src="emular_transito.html" class="content-iframe" title="Contenido principal"></iframe>
        </div>
      </main>
    </div>

    <!-- Bootstrap 5.3.8 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

    <script>
      urlIniciarVista = "/usuarios/admins/menu/vistaConectada";
      //urlCierreVista = "/usuarios/admins/acceso/logout";
      urlRegistroSSE = "/usuarios/admins/menu/registrarSSE"; // Al cargarse el menu admin se registra el SSE
      //urlIniciarVista = "/menu/vistaConectada";
      const spnNombreCompleto = document.getElementById("nombreCompleto");
      const sidebar = document.getElementById("sidebar");
      const sidebarOverlay = document.getElementById("sidebarOverlay");
      const mobileMenuToggle = document.getElementById("mobileMenuToggle");

      // Load content into iframe
      function cargarContenido(pagina) {
        document.getElementById("contenidoFrame").src = pagina;

        // Update active state in nav
        document.querySelectorAll(".sidebar-nav-link").forEach((link) => {
          link.classList.remove("active");
        });
        const pageName = pagina.replace(".html", "");
        const activeLink = document.querySelector(`[data-page="${pageName}"]`);
        if (activeLink) {
          activeLink.classList.add("active");
        }

        // Close mobile menu after selection
        if (window.innerWidth <= 991) {
          closeMobileMenu();
        }
      }

      // Logout function
      function logout() {
        submit("acceso/logout", null);
      }

      // Handle unauthenticated user
      function mostrar_usuarioNoAutenticado(urlDestino) {
        console.log("Usuario no autenticado. Redirigiendo a:", urlDestino);
        window.location.href = urlDestino;
      }

      function mostrar_logoutExitoso(urlDestino) {
        console.log("Logout exitoso. Redirigiendo a:", urlDestino);
        window.location.href = urlDestino;
      }

      // Display user full name
      function mostrar_nombreCompleto(nombreCompleto) {
        spnNombreCompleto.textContent = nombreCompleto.toUpperCase();
      }

      // Mobile menu toggle functionality
      function toggleMobileMenu() {
        sidebar.classList.toggle("active");
        sidebarOverlay.classList.toggle("active");
      }

      function closeMobileMenu() {
        sidebar.classList.remove("active");
        sidebarOverlay.classList.remove("active");
      }

      // Event listeners for mobile menu
      mobileMenuToggle.addEventListener("click", toggleMobileMenu);
      sidebarOverlay.addEventListener("click", closeMobileMenu);

      // Close menu on window resize if mobile menu is open
      window.addEventListener("resize", () => {
        if (window.innerWidth > 991) {
          closeMobileMenu();
        }
      });

      // Handle escape key to close mobile menu
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && sidebar.classList.contains("active")) {
          closeMobileMenu();
        }
      });

      //Procesa los mensajes recibidos por SSE
      function procesarMensajeSSE(mensaje) {
        console.log("Mensaje recibido por SSE:", mensaje);
        var iframe = document.getElementById("contenidoFrame");
        var iframeWindow = iframe.contentWindow;
        iframeWindow.procesarResultadosSubmit(mensaje); //asumo que el iFrame tiene vistaWeb.js incluida
      }

      //Se ejecuta cuando se cierra la conexion desde el servidor
      //Si no se define esta funcion, por defecto se "borra" la pagina
      function conexionSSECerrada(event) {
        console.log("Conexión SSE cerrada:", event);
        cerrar();
      }
      async function cerrar() {
        console.log("Cerrando la aplicación en esta ventana");
        let respuesta = await mostrarConfirmacion("Se ha cerrado la aplicación en esta ventana", "Intentar volver a abrirla", "Cerrar");
        if (respuesta) {
          location.reload();
        } else {
          document.body.innerHTML = "";
        }
      }
    </script>
  </body>
</html>
